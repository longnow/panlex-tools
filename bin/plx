#!/usr/bin/env perl
use strict;
no strict 'refs';
use encoding 'utf8';

use File::Spec::Functions qw/catdir catfile curdir rel2abs splitdir/;
use File::Copy qw/copy/;

usage(), exit(0) unless @ARGV;

utf8::upgrade($_) for @ARGV;
my $cmd = shift @ARGV;
my $cmd_sub = 'cmd_'.$cmd;

if (exists &$cmd_sub) {
    &$cmd_sub(@ARGV);
} else {
    print STDERR "Unknown command: $cmd\n\n";
    usage();
}

sub cmd_cp {
    my ($tool, $dest) = @_;

    print(STDERR "You need to specify a tool.\n"), return unless $tool;
    check_env(qw/PANLEX_TOOLDIR/);

    $dest ||= $tool;
    $tool .= '.pl' unless $tool =~ /\./;
    $dest .= '.pl' unless $dest =~ /\./;

    my $sourcedir = rel2abs(curdir());

    my $source;
    foreach my $dir (reverse splitdir($sourcedir)) {
        if ($dir =~ /^[a-z]{3}-/) {
            $source = $dir;
            last;
        }
    }
    $source ||= 'aaa-bbb-Author';

    foreach my $dir ( ['serialize'], ['serialize', 'sub'], ['tabularize', 'util'] ) {
        my $file = catfile($ENV{PANLEX_TOOLDIR}, @$dir, $tool);
        
        if (-e $file) {
            cp_file($file, $dest, $source);
            return;
        }
    }

    my @tabularize = glob(catfile($ENV{PANLEX_TOOLDIR}, 'tabularize', '*', $tool));
    
    if (@tabularize) {
        cp_file($tabularize[0], "${source}.${dest}", $source);
        return;
    }
    
    print STDERR "could not find panlex tool $tool\n";
}

sub cp_file {
    my ($source_file, $target_file, $source_label) = @_;

    open my $fd, '<:utf8', $source_file or die $!;
    my $data = do { local $/; <$fd> };
    close $fd;
    
    $data =~ s/aaa-bbb-Author/$source_label/;
    
    open $fd, '>:utf8', $target_file or die $!;
    print $fd $data;
    close $fd;
    
    my $mode = (stat($source_file))[2] & 07777;
    chmod $mode, $target_file;
}

sub usage {
    print STDERR <<EOF;
Usage: $0 <command> [options]

Commands:

cp <tool>
    copy panlex tool into the current directory
    
Environment variables:

PANLEX_TOOLDIR      local directory containing panlex-tools
EOF
}

sub check_env {
    my %error;
    
    foreach my $var (grep { !defined $ENV{$_} } @_) {
        print STDERR "The environment variable $var must be set to execute this command.\n";
        $error{$var} = 1;
    }
    
    foreach my $dir (grep { /DIR$/ && ! -d $ENV{$_} && !$error{$_} } @_) {
        print STDERR "The environment variable $dir ($ENV{$dir}) must be set to a valid directory to execute this command.\n";
        $error{$dir} = 1;
    }
    
    keys %error > 0 && exit(0);
}

sub shell_cmd {
    my (@cmd) = @_;
    print "@cmd\n";
    return system(@cmd) >> 8;
}
